{% extends "base.html" %}

{% block title %}Problems{% endblock %}

{% block content %}
<div class="ui container">
    <div class="ui toggle checkbox" style="margin-top: 20px;">
        <input type="checkbox" id="use-median">
        <label>Use Median</label>
    </div>
    <div class="column" style="margin-top: 20px;">
        <table class="ui left aligned table" id="problems-table">
            <thead>
                <th>Pid</th>
                <th id="contest-header">Contest ▾</th>
                <th>Name</th>
                <th id="difficulty-header">Difficulty ▴</th>
                <th id="quality-header">Quality ▴</th>
                <th>Vote</th>
                <th>Show Votes</th>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <div class="ui modal" id="vote">
        <div class="header">
            Vote
        </div>
        <div class="content">
            <div class="ui labeled input" style="margin-right: 10px;">
                <div class="ui label">
                    Difficulty(800-3500)
                </div>
                <input type="number" placeholder="Difficulty" data-tribute="true" id="difficulty">
            </div>
            <div class="ui labeled input">
                <div class="ui label">
                    Quality(1-5)
                </div>
                <input type="number" placeholder="Quality" data-tribute="true" id="quality">
            </div>
            <div class="ui labeled input">
                <div class="ui label">
                    Comment
                </div>
                <input type="text" placeholder="Comment" data-tribute="true" id="comment">
            </div>
        </div>
        <div class="actions">
            <div class="ui black deny button">
                Cancel
            </div>
            <div class="ui positive button">
                Save
            </div>
        </div>
    </div>
    <div class="ui modal" id="show-votes">
        <div class="header">
            Show Votes
        </div>
        <div class="content">
            <table class="ui left aligned table" id="vote-table">
                <thead>
                    <th>Difficulty</th>
                    <th>Quality</th>
                    <th>Comments</th>
                    <th>Report</th>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <div class="actions">
            <div class="ui positive button">
                OK
            </div>
        </div>
    </div>
</div>
<script>
    function showTable() {
        let table = $('#problems-table tbody');
        table.empty();
        for (let i = 0; i < data.length; i++) {
            let row = $('<tr>');
            row.append($('<td>').text(data[i]['pid']));
            row.append($('<td>').text(data[i]['contest']));
            row.append($('<td>').html(data[i]['name']));
            row.append(difficulty2Str(data[i]['difficulty'], data[i]['cnt1']));
            row.append(quality2Str(data[i]['quality'], data[i]['cnt2']));
            (function(pid) {
                row.append($('<td>').html("<a>Vote</a>").click(function () {
                    window.pid = pid;
                    Vote();
                }));
                row.append($('<td>').html("<a>Show Votes</a>").click(function () {
                    window.pid = pid;
                    $('#show-votes').modal('show');
                    showVotes();
                }));
            })(data[i]['pid']);
            table.append(row);
        }
    }
    function Vote() {
        $.ajax({
            url: '/backend/get_vote/',
            type: 'POST',
            data: {
                pid: window.pid
            },
            success: function (data) {
                $('#difficulty').val(data['difficulty']);
                $('#quality').val(data['quality']);
                $('#comment').val(data['comment']);
                $('#vote').modal('show');
            }
        });
    }
    function showVotes() {
        let table = $('#vote-table tbody');
        table.empty();
        $.ajax({
            url: '/backend/get_votes/',
            type: 'POST',
            data: {
                pid: window.pid
            },
            success: function (data) {
                for (let i = 0; i < data.length; i++) {
                    let row = $('<tr>');
                    row.append(difficulty2Str(data[i]['difficulty'], null));
                    row.append(quality2Str(data[i]['quality'], null));
                    row.append($('<td>').text(data[i]['comment']));
                    (function(id) {
                        row.append($('<td>').html("<a>Report</a>").click(function () {
                            $.ajax({
                                url: '/backend/report/',
                                type: 'POST',
                                data: {
                                    id: id
                                },
                                success: function (data) {
                                    alert("Report!");
                                }
                            });
                        }));
                    })(data[i]['id'])
                    table.append(row);
                }
            }
        });
    }
    $(document).ready(function () {
        $.ajax({
            url: '/backend/get_problems',
            type: 'GET',
            success: function (data) {
                window.data = data;
                showTable();
            }
        });

        $('#contest-header').click(function () {
            $('#contest-header').text('Contest ▾')
            $('#difficulty-header').text('Difficulty ▴')
            $('#quality-header').text('Quality ▴')
            data.sort(function (a, b) {
                if (a['contest'] > b['contest']) {
                    return -1;
                } else if (a['contest'] < b['contest']) {
                    return 1;
                } else {
                    return 0;
                }
            });
            showTable();
        });

        $('#difficulty-header').click(function () {
            $('#contest-header').text('Contest ▴')
            $('#difficulty-header').text('Difficulty ▾')
            $('#quality-header').text('Quality ▴')
            data.sort(function (a, b) {
                if (a['difficulty'] == null && b['difficulty'] == null) {
                    return 0;
                }
                if (a['difficulty'] == null) {
                    return 1;
                }
                if (b['difficulty'] == null) {
                    return -1
                }
                if (a['difficulty'] > b['difficulty']) {
                    return -1;
                } else if (a['difficulty'] < b['difficulty']) {
                    return 1;
                } else {
                    return 0;
                }
            });
            showTable();
        });

        $('#quality-header').click(function () {
            $('#contest-header').text('Contest ▴')
            $('#difficulty-header').text('Difficulty ▴')
            $('#quality-header').text('Quality ▾')
            data.sort(function (a, b) {
                if (a['quality'] == null && b['quality'] == null) {
                    return 0;
                }
                if (a['quality'] == null) {
                    return 1;
                }
                if (b['quality'] == null) {
                    return -1
                }
                if (a['quality'] > b['quality']) {
                    return -1;
                } else if (a['quality'] < b['quality']) {
                    return 1;
                } else {
                    return 0;
                }
            });
            showTable();
        });

        $('#use-median').click(function () {
            for (let i = 0; i < data.length; i++) {
                [data[i]['difficulty'], data[i]['difficulty2']] = [data[i]['difficulty2'], data[i]['difficulty']];
                [data[i]['quality'], data[i]['quality2']] = [data[i]['quality2'], data[i]['quality']];
            }
            showTable();
        });

        $('#vote .positive.button').click(function () {
            let difficulty = $('#difficulty').val();
            let quality = $('#quality').val();
            let comment = $('#comment').val();
            if (difficulty < 800 || difficulty > 3500) {
                difficulty = -1;
            }
            if (quality < 1 || quality > 5) {
                quality = -1;
            }
            $.ajax({
                url: '/backend/vote/',
                type: 'POST',
                data: {
                    pid: window.pid,
                    difficulty: difficulty,
                    quality: quality,
                    comment: comment
                },
                success: function (data) {
                    location.reload();
                }
            });
        });
    });
</script>
{% endblock %}